import y from"express";import A from"path";import{fileURLToPath as _}from"url";import{createServer as N}from"http";import{randomUUID as v}from"crypto";var x=class{users;products;searches;constructor(){this.users=new Map,this.products=new Map,this.searches=new Map}async getUser(t){return this.users.get(t)}async getUserByUsername(t){return Array.from(this.users.values()).find(e=>e.username===t)}async createUser(t){let e=v(),r={...t,id:e};return this.users.set(e,r),r}async getAllProducts(){return Array.from(this.products.values())}async getProduct(t){return this.products.get(t)}async getProductsByCategory(t){return Array.from(this.products.values()).filter(e=>e.category.toLowerCase()===t.toLowerCase())}async createProduct(t){let e=v(),r={...t,id:e,rating:t.rating??4,reviewCount:t.reviewCount??0,embeddings:t.embeddings??null,createdAt:new Date};return this.products.set(e,r),r}async createSearch(t){let e=v(),r={...t,id:e,imageUrl:t.imageUrl??null,embeddings:t.embeddings??null,createdAt:new Date};return this.searches.set(e,r),r}async searchSimilarProducts(t,e,r=.3,i=20){let o=e?await this.getProductsByCategory(e):await this.getAllProducts(),a=[];for(let s of o){if(!s.embeddings||s.embeddings.length===0)continue;let n=this.cosineSimilarity(t,s.embeddings);n>=r&&a.push({product:s,similarity:n})}return a.sort((s,n)=>n.similarity-s.similarity).slice(0,i)}cosineSimilarity(t,e){if(t.length!==e.length)return 0;let r=0,i=0,o=0;for(let a=0;a<t.length;a++)r+=t[a]*e[a],i+=t[a]*t[a],o+=e[a]*e[a];return i===0||o===0?0:r/(Math.sqrt(i)*Math.sqrt(o))}},p=new x;import{sql as U}from"drizzle-orm";import{pgTable as S,text as u,varchar as P,real as b,integer as L,timestamp as M}from"drizzle-orm/pg-core";import{createInsertSchema as C}from"drizzle-zod";import{z as g}from"zod";var T=S("users",{id:P("id").primaryKey().default(U`gen_random_uuid()`),username:u("username").notNull().unique(),password:u("password").notNull()}),q=S("products",{id:P("id").primaryKey().default(U`gen_random_uuid()`),name:u("name").notNull(),description:u("description").notNull(),category:u("category").notNull(),price:b("price").notNull(),imageUrl:u("image_url").notNull(),rating:b("rating").default(4),reviewCount:L("review_count").default(0),embeddings:b("embeddings").array(),createdAt:M("created_at").defaultNow()}),z=S("searches",{id:P("id").primaryKey().default(U`gen_random_uuid()`),imageUrl:u("image_url"),embeddings:b("embeddings").array(),createdAt:M("created_at").defaultNow()}),Q=C(T).pick({username:!0,password:!0}),Y=C(q).omit({id:!0,createdAt:!0}),Z=C(z).omit({id:!0,createdAt:!0}),H=g.object({imageUrl:g.string().url().optional(),imageData:g.string().optional(),category:g.string().optional(),minSimilarity:g.number().min(0).max(1).default(.3),limit:g.number().min(1).max(50).default(20)});import*as d from"@tensorflow/tfjs-node";var F=class{model=null;async initializeModel(){try{this.model=d.sequential({layers:[d.layers.dense({units:128,activation:"relu",inputShape:[224*224*3]}),d.layers.dense({units:64,activation:"relu"}),d.layers.dense({units:10,activation:"linear"})]})}catch(t){console.error("Failed to initialize ML model:",t)}}async extractFeatures(t){try{let e=d.node.decodeImage(t,3).resizeBilinear([224,224]).expandDims(0).div(255);if(this.model){let r=this.model.predict(e.flatten().expandDims(0)),i=await r.data();return e.dispose(),r.dispose(),Array.from(i)}else{let r=await e.data(),i=this.generateSimpleFeatures(Array.from(r));return e.dispose(),i}}catch(e){return console.error("Feature extraction failed:",e),Array.from({length:10},()=>Math.random())}}generateSimpleFeatures(t){let e=[],r=0,i=0,o=0;for(let m=0;m<t.length;m+=3)r+=t[m],i+=t[m+1],o+=t[m+2];let a=t.length/3,s=r/a/255,n=i/a/255,l=o/a/255;e.push(s),e.push(n),e.push(l);let f=(r+i+o)/(a*3*255);e.push(f);let k=0,B=f*255;for(let m=0;m<t.length;m+=3){let R=(t[m]+t[m+1]+t[m+2])/3;k+=Math.pow(R-B,2)}return e.push(Math.sqrt(k/a)/255),e.push(Math.abs(s-n)),e.push(Math.abs(n-l)),e.push(Math.abs(s-l)),e.push((s+n+l)/3),e.push(Math.max(s,n,l)),e}async extractFeaturesFromUrl(t){try{let e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch image: ${e.statusText}`);let r=await e.arrayBuffer(),i=Buffer.from(r);return await this.extractFeatures(i)}catch(e){throw console.error("URL feature extraction failed:",e),e}}},w=new F;var E=[{name:"Designer Leather Handbag",description:"Premium Italian leather handbag with gold hardware and adjustable strap",category:"Fashion",price:299.99,imageUrl:"https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:128,embeddings:[.6,.4,.3,.7,.2,.5,.8,.4,.6,.9]},{name:"Classic Denim Jacket",description:"Vintage-style denim jacket with distressed finish and multiple pockets",category:"Fashion",price:89.99,imageUrl:"https://images.unsplash.com/photo-1551698618-1dfe5d97d256?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.2,reviewCount:89,embeddings:[.4,.3,.5,.6,.2,.7,.5,.4,.8,.6]},{name:"Premium Cotton T-Shirt",description:"Soft organic cotton t-shirt with perfect fit and fade-resistant colors",category:"Fashion",price:34.99,imageUrl:"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.7,reviewCount:245,embeddings:[.5,.6,.4,.7,.3,.8,.6,.5,.7,.4]},{name:"Designer Sneakers",description:"Limited edition sneakers with premium materials and comfortable sole",category:"Fashion",price:159.99,imageUrl:"https://images.unsplash.com/photo-1549298916-b41d501d3772?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:156,embeddings:[.4,.3,.2,.1,.8,.7,.6,.5,1,.9]},{name:"Wool Blend Scarf",description:"Luxurious wool blend scarf with cashmere touch and elegant patterns",category:"Fashion",price:45.99,imageUrl:"https://images.unsplash.com/photo-1601924994987-69e26d50dc26?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:67,embeddings:[.5,.6,.3,.4,.9,1,.7,.8,.1,.2]},{name:"Silk Evening Dress",description:"Elegant silk evening dress with flowing silhouette and delicate details",category:"Fashion",price:199.99,imageUrl:"https://images.unsplash.com/photo-1595777457583-95e059d581b8?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.8,reviewCount:92,embeddings:[.6,.5,.4,.3,1,.9,.8,.7,.2,.1]},{name:"Leather Belt",description:"Genuine leather belt with classic buckle and adjustable length",category:"Fashion",price:59.99,imageUrl:"https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.1,reviewCount:34,embeddings:[.7,.8,.5,.6,.1,.2,.9,1,.3,.4]},{name:"Cashmere Sweater",description:"Ultra-soft cashmere sweater with ribbed cuffs and hem",category:"Fashion",price:129.99,imageUrl:"https://images.unsplash.com/photo-1434389677669-e08b4cac3105?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:78,embeddings:[.8,.7,.6,.5,.2,.1,1,.9,.4,.3]},{name:"Athletic Running Shoes",description:"High-performance running shoes with advanced cushioning technology",category:"Fashion",price:119.99,imageUrl:"https://images.unsplash.com/photo-1542291026-7eec264c27ff?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:203,embeddings:[.9,1,.7,.8,.3,.4,.1,.2,.5,.6]},{name:"Designer Sunglasses",description:"Premium polarized sunglasses with UV protection and scratch-resistant coating",category:"Fashion",price:189.99,imageUrl:"https://images.unsplash.com/photo-1572635196237-14b3f281503f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:145,embeddings:[1,.9,.8,.7,.4,.3,.2,.1,.6,.5]},{name:"Premium Smartphone Pro",description:"Latest flagship smartphone with advanced camera system and 5G connectivity",category:"Electronics",price:899.99,imageUrl:"https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:1024,embeddings:[.1,.3,.2,.4,.5,.7,.6,.8,.9,1]},{name:"Wireless Earbuds Pro",description:"True wireless earbuds with active noise cancellation and premium sound",category:"Electronics",price:249.99,imageUrl:"https://images.unsplash.com/photo-1572569511254-d8f925fe2cbb?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:567,embeddings:[.2,.4,.1,.3,.6,.8,.5,.7,1,.9]},{name:"Ultra-Thin Laptop",description:"Powerful laptop with retina display and all-day battery life",category:"Electronics",price:1299.99,imageUrl:"https://images.unsplash.com/photo-1496181133206-80ce9b88a853?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.7,reviewCount:432,embeddings:[.3,.1,.4,.2,.7,.5,.8,.6,.9,1]},{name:"Professional Tablet",description:"High-performance tablet perfect for creative professionals with stylus support",category:"Electronics",price:799.99,imageUrl:"https://images.unsplash.com/photo-1544244015-0df4b3ffc6b0?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:289,embeddings:[.4,.2,.3,.1,.8,.6,.7,.5,1,.9]},{name:"Smart Watch Series X",description:"Advanced smartwatch with health monitoring and fitness tracking",category:"Electronics",price:399.99,imageUrl:"https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:178,embeddings:[.5,.3,.2,.4,.9,.7,.6,.8,.1,1]},{name:"Wireless Headphones",description:"Over-ear wireless headphones with superior sound quality and comfort",category:"Electronics",price:199.99,imageUrl:"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:345,embeddings:[.6,.4,.1,.3,1,.8,.5,.7,.2,.9]},{name:"Gaming Console",description:"Next-generation gaming console with 4K graphics and fast loading",category:"Electronics",price:499.99,imageUrl:"https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.8,reviewCount:892,embeddings:[.7,.5,.4,.2,.1,.9,.8,.6,.3,1]},{name:"4K Webcam",description:"Professional 4K webcam with auto-focus and noise cancellation",category:"Electronics",price:149.99,imageUrl:"https://images.unsplash.com/photo-1587825140708-dfaf72ae4b04?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.2,reviewCount:123,embeddings:[.8,.6,.3,.1,.2,1,.9,.5,.4,.7]},{name:"Bluetooth Speaker",description:"Portable Bluetooth speaker with 360-degree sound and waterproof design",category:"Electronics",price:79.99,imageUrl:"https://images.unsplash.com/photo-1608043152269-423dbba4e7e1?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.1,reviewCount:89,embeddings:[.9,.7,.2,.4,.3,.1,1,.8,.5,.6]},{name:"USB-C Hub",description:"Multi-port USB-C hub with HDMI, USB 3.0, and fast charging support",category:"Electronics",price:59.99,imageUrl:"https://images.unsplash.com/photo-1625842268584-8f3296236761?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4,reviewCount:67,embeddings:[1,.8,.1,.3,.4,.2,.9,.7,.6,.5]},{name:"Modern Table Lamp",description:"Minimalist table lamp with adjustable brightness and USB charging port",category:"Home Decor",price:79.99,imageUrl:"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:156,embeddings:[.1,.4,.3,.2,.5,.8,.7,.6,.9,1]},{name:"Ceramic Vase Set",description:"Handcrafted ceramic vases in modern geometric shapes",category:"Home Decor",price:49.99,imageUrl:"https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:78,embeddings:[.2,.3,.4,.1,.6,.7,.8,.5,1,.9]},{name:"Abstract Wall Art",description:"Contemporary abstract wall art print on premium canvas",category:"Home Decor",price:89.99,imageUrl:"https://images.unsplash.com/photo-1541961017774-22349e4a1262?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:134,embeddings:[.3,.2,.1,.4,.7,.6,.5,.8,.9,1]},{name:"Decorative Mirror",description:"Round decorative mirror with gold frame and beveled edges",category:"Home Decor",price:119.99,imageUrl:"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:89,embeddings:[.4,.1,.2,.3,.8,.5,.6,.7,1,.9]},{name:"Luxury Candle Set",description:"Premium scented candles in elegant glass containers with wooden wicks",category:"Home Decor",price:65.99,imageUrl:"https://images.unsplash.com/photo-1602874801006-3d8b9b0c4e92?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.7,reviewCount:167,embeddings:[.5,.2,.3,.4,.9,.6,.7,.8,.1,1]},{name:"Throw Pillow Set",description:"Set of decorative throw pillows with premium fabric and hidden zippers",category:"Home Decor",price:39.99,imageUrl:"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.2,reviewCount:95,embeddings:[.6,.3,.4,.1,1,.7,.8,.5,.2,.9]},{name:"Indoor Plant Pot",description:"Modern ceramic plant pot with drainage system and matching saucer",category:"Home Decor",price:29.99,imageUrl:"https://images.unsplash.com/photo-1485955900006-10f4d324d411?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.1,reviewCount:56,embeddings:[.7,.4,.1,.2,.3,.8,.9,.6,.5,1]},{name:"Wall Clock Modern",description:"Minimalist wall clock with silent movement and sleek design",category:"Home Decor",price:44.99,imageUrl:"https://images.unsplash.com/photo-1563861826100-9cb868fdbe1c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:72,embeddings:[.8,.5,.2,.3,.4,.9,1,.7,.6,.1]},{name:"Pendant Light Fixture",description:"Modern pendant light with adjustable height and warm LED bulb",category:"Home Decor",price:99.99,imageUrl:"https://images.unsplash.com/photo-1524484485831-a92ffc0de03f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:123,embeddings:[.9,.6,.3,.4,.5,1,.1,.8,.7,.2]},{name:"Area Rug Premium",description:"Handwoven area rug with geometric patterns and soft texture",category:"Home Decor",price:159.99,imageUrl:"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:89,embeddings:[1,.7,.4,.5,.6,.1,.2,.9,.8,.3]},{name:"Ergonomic Office Chair",description:"Premium office chair with lumbar support and adjustable height",category:"Furniture",price:299.99,imageUrl:"https://images.unsplash.com/photo-1586024229174-4293dd8af128?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:234,embeddings:[.1,.5,.4,.3,.2,.6,.7,.8,.9,1]},{name:"Modern Coffee Table",description:"Glass-top coffee table with sleek metal frame and storage shelf",category:"Furniture",price:189.99,imageUrl:"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:145,embeddings:[.2,.6,.3,.4,.1,.7,.8,.5,1,.9]},{name:"Dining Table Set",description:"Solid wood dining table set for 6 with matching chairs",category:"Furniture",price:599.99,imageUrl:"https://images.unsplash.com/photo-1549497538-303791108f95?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.7,reviewCount:167,embeddings:[.3,.7,.2,.5,.4,.8,.9,.6,.1,1]},{name:"Velvet Sofa",description:"Luxurious velvet sofa with deep seating and brass legs",category:"Furniture",price:899.99,imageUrl:"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:198,embeddings:[.4,.8,.1,.6,.5,.9,1,.7,.2,.3]},{name:"Bookshelf Unit",description:"5-tier wooden bookshelf with adjustable shelves and modern design",category:"Furniture",price:149.99,imageUrl:"https://images.unsplash.com/photo-1586024229174-4293dd8af128?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.2,reviewCount:87,embeddings:[.5,.9,.2,.7,.6,1,.1,.8,.3,.4]},{name:"Accent Chair",description:"Mid-century modern accent chair with comfortable cushioning",category:"Furniture",price:249.99,imageUrl:"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:112,embeddings:[.6,1,.3,.8,.7,.1,.2,.9,.4,.5]},{name:"Standing Desk",description:"Height-adjustable standing desk with memory presets and cable management",category:"Furniture",price:399.99,imageUrl:"https://images.unsplash.com/photo-1549497538-303791108f95?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:203,embeddings:[.7,.1,.4,.9,.8,.2,.3,1,.5,.6]},{name:"Storage Ottoman",description:"Multi-functional storage ottoman with soft upholstery and hidden compartment",category:"Furniture",price:69.99,imageUrl:"https://images.unsplash.com/photo-1506439773649-6e0eb8cfb237?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.1,reviewCount:45,embeddings:[.8,.2,.5,1,.9,.3,.4,.1,.6,.7]},{name:"Nightstand Drawer",description:"Modern nightstand with drawer and open shelf for bedroom storage",category:"Furniture",price:89.99,imageUrl:"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:76,embeddings:[.9,.3,.6,.1,1,.4,.5,.2,.7,.8]},{name:"Bar Stool Set",description:"Set of 2 adjustable bar stools with swivel seats and footrest",category:"Furniture",price:179.99,imageUrl:"https://images.unsplash.com/photo-1549497538-303791108f95?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.2,reviewCount:98,embeddings:[1,.4,.7,.2,.1,.5,.6,.3,.8,.9]},{name:"Leather Wallet",description:"Handcrafted genuine leather wallet with RFID blocking technology",category:"Accessories",price:79.99,imageUrl:"https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:123,embeddings:[.1,.6,.5,.4,.3,.7,.8,.9,1,.2]},{name:"Gold Necklace",description:"14k gold chain necklace with delicate pendant and secure clasp",category:"Accessories",price:199.99,imageUrl:"https://images.unsplash.com/photo-1515562141207-7a88fb7ce338?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:189,embeddings:[.2,.7,.6,.5,.4,.8,.9,1,.1,.3]},{name:"Titanium Watch",description:"Precision titanium watch with sapphire crystal and water resistance",category:"Accessories",price:349.99,imageUrl:"https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.8,reviewCount:234,embeddings:[.3,.8,.7,.6,.5,.9,1,.1,.2,.4]},{name:"Silk Tie",description:"Pure silk necktie with classic pattern and perfect width",category:"Accessories",price:49.99,imageUrl:"https://images.unsplash.com/photo-1594736797933-d0d3648851f8?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:67,embeddings:[.4,.9,.8,.7,.6,1,.1,.2,.3,.5]},{name:"Leather Briefcase",description:"Professional leather briefcase with laptop compartment and shoulder strap",category:"Accessories",price:229.99,imageUrl:"https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:156,embeddings:[.5,1,.9,.8,.7,.1,.2,.3,.4,.6]},{name:"Designer Backpack",description:"Waterproof designer backpack with multiple compartments and USB port",category:"Accessories",price:139.99,imageUrl:"https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:178,embeddings:[.6,.1,1,.9,.8,.2,.3,.4,.5,.7]},{name:"Cufflinks Set",description:"Sterling silver cufflinks with elegant design and gift box",category:"Accessories",price:89.99,imageUrl:"https://images.unsplash.com/photo-1515562141207-7a88fb7ce338?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.2,reviewCount:43,embeddings:[.7,.2,.1,1,.9,.3,.4,.5,.6,.8]},{name:"Pearl Earrings",description:"Freshwater pearl earrings with sterling silver posts and backs",category:"Accessories",price:119.99,imageUrl:"https://images.unsplash.com/photo-1515562141207-7a88fb7ce338?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.7,reviewCount:134,embeddings:[.8,.3,.2,.1,1,.4,.5,.6,.7,.9]},{name:"Travel Jewelry Case",description:"Compact jewelry organizer with velvet compartments and mirror",category:"Accessories",price:39.99,imageUrl:"https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.1,reviewCount:89,embeddings:[.9,.4,.3,.2,.1,.5,.6,.7,.8,1]},{name:"Smart Coffee Maker",description:"Programmable coffee maker with app control and thermal carafe",category:"Home",price:129.99,imageUrl:"https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:267,embeddings:[.1,.7,.6,.5,.4,.8,.9,1,.2,.3]},{name:"Air Purifier",description:"HEPA air purifier with quiet operation and smart air quality monitoring",category:"Home",price:199.99,imageUrl:"https://images.unsplash.com/photo-1558618666-fcd25c85cd64?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:189,embeddings:[.2,.8,.7,.6,.5,.9,1,.1,.3,.4]},{name:"Robot Vacuum",description:"Smart robot vacuum with mapping technology and app control",category:"Home",price:299.99,imageUrl:"https://images.unsplash.com/photo-1577633120488-51d0b96e5509?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:345,embeddings:[.3,.9,.8,.7,.6,1,.1,.2,.4,.5]},{name:"Humidifier",description:"Ultrasonic humidifier with essential oil diffuser and LED lighting",category:"Home",price:59.99,imageUrl:"https://images.unsplash.com/photo-1544966503-7cc5ac882d5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.2,reviewCount:156,embeddings:[.4,1,.9,.8,.7,.1,.2,.3,.5,.6]},{name:"Electric Kettle",description:"Stainless steel electric kettle with temperature control and keep-warm function",category:"Home",price:79.99,imageUrl:"https://images.unsplash.com/photo-1544966503-7cc5ac882d5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.6,reviewCount:234,embeddings:[.5,.1,1,.9,.8,.2,.3,.4,.6,.7]},{name:"Smart Thermostat",description:"WiFi-enabled smart thermostat with energy saving features",category:"Home",price:179.99,imageUrl:"https://images.unsplash.com/photo-1558618666-fcd25c85cd64?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.7,reviewCount:298,embeddings:[.6,.2,.1,1,.9,.3,.4,.5,.7,.8]},{name:"Blender Pro",description:"High-power blender with multiple speed settings and glass pitcher",category:"Home",price:149.99,imageUrl:"https://images.unsplash.com/photo-1570197788417-0e82375c9371?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.5,reviewCount:167,embeddings:[.7,.3,.2,.1,1,.4,.5,.6,.8,.9]},{name:"Essential Oil Diffuser",description:"Ultrasonic essential oil diffuser with color-changing LED lights",category:"Home",price:39.99,imageUrl:"https://images.unsplash.com/photo-1546518799-dd0de9b5501c?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.3,reviewCount:123,embeddings:[.8,.4,.3,.2,.1,.5,.6,.7,.9,1]},{name:"Smart Scale",description:"Digital bathroom scale with body composition analysis and app sync",category:"Home",price:49.99,imageUrl:"https://images.unsplash.com/photo-1494173853739-c21f58b16055?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.1,reviewCount:89,embeddings:[.9,.5,.4,.3,.2,.6,.7,.8,1,.1]},{name:"Food Processor",description:"Multi-function food processor with various blades and large capacity bowl",category:"Home",price:119.99,imageUrl:"https://images.unsplash.com/photo-1570197788417-0e82375c9371?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=400",rating:4.4,reviewCount:145,embeddings:[1,.6,.5,.4,.3,.7,.8,.9,.1,.2]}];import I from"multer";var W=I({storage:I.memoryStorage(),limits:{fileSize:10*1024*1024},fileFilter:(c,t,e)=>{t.mimetype.startsWith("image/")?e(null,!0):e(new Error("Only image files are allowed"))}});async function D(c){await w.initializeModel(),console.log("Initializing sample products...");for(let e of E)try{await p.createProduct(e)}catch(r){console.error("Failed to create product:",r)}return c.get("/api/products",async(e,r)=>{try{let i=await p.getAllProducts();r.json(i)}catch(i){console.error("Failed to get products:",i),r.status(500).json({message:"Failed to fetch products"})}}),c.get("/api/products/category/:category",async(e,r)=>{try{let{category:i}=e.params,o=await p.getProductsByCategory(i);r.json(o)}catch(i){console.error("Failed to get products by category:",i),r.status(500).json({message:"Failed to fetch products"})}}),c.post("/api/search/upload",W.single("image"),async(e,r)=>{try{if(!e.file)return r.status(400).json({message:"No image file provided"});let{category:i,minSimilarity:o=.3,limit:a=20}=e.body,s=await w.extractFeatures(e.file.buffer),n=await p.searchSimilarProducts(s,i,parseFloat(o),parseInt(a));await p.createSearch({embeddings:s,imageUrl:null}),r.json({results:n,total:n.length,query:{category:i||"all",minSimilarity:parseFloat(o),limit:parseInt(a)}})}catch(i){console.error("Search upload failed:",i),r.status(500).json({message:"Failed to process image search"})}}),c.post("/api/search/url",async(e,r)=>{try{let i=H.safeParse(e.body);if(!i.success)return r.status(400).json({message:"Invalid request data",errors:i.error.errors});let{imageUrl:o,category:a,minSimilarity:s,limit:n}=i.data;if(!o)return r.status(400).json({message:"Image URL is required"});let l=await w.extractFeaturesFromUrl(o),f=await p.searchSimilarProducts(l,a,s,n);await p.createSearch({embeddings:l,imageUrl:o}),r.json({results:f,total:f.length,query:{imageUrl:o,category:a||"all",minSimilarity:s,limit:n}})}catch(i){console.error("Search URL failed:",i),r.status(500).json({message:"Failed to process image search"})}}),c.get("/api/searches",async(e,r)=>{try{r.json([])}catch(i){console.error("Failed to get search history:",i),r.status(500).json({message:"Failed to fetch search history"})}}),N(c)}var h=y(),O=A.dirname(_(import.meta.url));h.use(y.json());h.use(y.urlencoded({extended:!0}));h.use((c,t,e)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization"),c.method==="OPTIONS"?t.sendStatus(200):e()});var j=A.resolve(O,"..","dist","public");h.use(y.static(j));D(h).then(()=>{console.log("Routes registered successfully")}).catch(c=>{console.error("Failed to register routes:",c)});h.get("*",(c,t)=>{c.path.startsWith("/api")?t.status(404).json({message:"API endpoint not found"}):t.sendFile(A.resolve(j,"index.html"))});var he=h;export{he as default};
